

## 📖 更新后的需求文档

### 1. 用户认证模块

#### 1.1 注册功能
- **页面**：独立注册页面
- **字段**：用户名、邮箱、昵称、密码、确认密码
- **验证规则**：
  - 用户名：≥4位，唯一性校验
  - 密码：≥8位
  - 确认密码：与密码一致
  - 邮箱：格式校验，唯一性校验
- **流程**：注册成功后跳转到登录页面

#### 1.2 登录功能
- **页面**：系统入口页面
- **字段**：用户名、密码
- **界面元素**：登录表单下方显示注册按钮和提示文字
- **会话管理**：JWT token 有效期18小时
- **禁用用户处理**：验证成功但用户被禁用时，显示"账号已被封禁，请联系管理员"，保持在登录界面

### 2. 用户管理模块（管理员专用）

#### 2.1 用户列表
- **展示信息**：用户名、邮箱、昵称、角色、状态、注册时间、**最后登录时间**
- **操作功能**：
  - 禁用/启用用户
  - 删除用户
  - 重置密码（默认重置为 `12345678`）
  - 设置角色（普通用户/管理员）

### 3. 个人信息模块

#### 3.1 信息展示
- **展示内容**：用户名、邮箱、昵称、注册时间、角色、**最后登录时间**

#### 3.2 信息编辑
- **可编辑字段**：昵称、邮箱
- **密码修改**：当前密码验证 + 新密码设置

### 4. 导航系统

#### 4.1 导航栏设计
- **位置**：页面左侧
- **普通用户菜单**：任务列表、个人信息
- **管理员菜单**：任务列表、个人信息、用户管理

### 5. Todo管理模块升级

#### 5.1 数据模型扩展
- **新增字段**：创建人（外键关联用户）、删除标记（布尔值）
- **复用字段**：使用现有的 `updated_at` 字段记录删除时间

#### 5.2 权限控制
- **普通用户**：只能查看和操作自己创建的未删除Todo
- **管理员**：可以查看所有用户的Todo（包括已删除）

#### 5.3 软删除功能
- **删除操作**：标记为删除，更新 `updated_at` 时间
- **显示规则**：
  - 普通用户：只显示未删除的Todo
  - 管理员：显示所有Todo，删除的用浅灰色标识
- **恢复功能**：管理员可将删除标记置为否，恢复Todo
- **图标设计**：删除标记的Todo显示"撤回"图标而非"删除"图标

---

## 🚀 更新后的开发方案

### 技术栈保持
- **后端**：Django + Django REST Framework + JWT认证
- **前端**：React + Axios + Context API（状态管理）
- **数据库**：SQLite（开发环境）

### 开发任务重新分解

#### 阶段一：后端用户认证系统（3-4天）

**任务1.1：用户模型设计和JWT认证配置**
- 扩展Django User模型（添加昵称、最后登录时间、用户状态等字段）
- 安装配置 `djangorestframework-simplejwt`
- 设置JWT token有效期为18小时
- 创建用户序列化器

**任务1.2：用户注册和登录API**
- 实现用户注册API（用户名、邮箱、昵称、密码验证）
- 实现登录API（用户名密码验证 + 禁用用户检查）
- 实现JWT token刷新机制
- 添加最后登录时间更新逻辑

**任务1.3：权限系统和用户管理API**
- 实现基于角色的权限装饰器
- 创建用户管理API（列表、禁用/启用、删除、角色设置）
- 实现密码重置API（重置为12345678）
- 个人信息查看和编辑API

#### 阶段二：Todo模型升级（1-2天）

**任务2.1：Todo模型扩展和迁移**
- 添加创建人字段（ForeignKey to User）
- 添加删除标记字段（BooleanField）
- 创建数据库迁移文件
- 为现有Todo数据设置默认创建人

**任务2.2：Todo API权限控制升级**
- 更新Todo序列化器（包含创建人信息）
- 实现基于用户的数据过滤（普通用户只看自己的）
- 实现软删除逻辑（更新删除标记和updated_at）
- 添加管理员恢复Todo的API

#### 阶段三：前端认证系统（3-4天）

**任务3.1：认证状态管理**
- 创建AuthContext（用户信息、登录状态、权限）
- 实现JWT token存储和自动刷新
- 创建API拦截器（自动添加token、处理401错误）
- 实现路由守卫组件

**任务3.2：登录注册页面**
- 创建登录页面组件（用户名、密码、注册按钮）
- 创建注册页面组件（完整表单验证）
- 实现表单验证（前端 + 后端错误处理）
- 添加禁用用户提示逻辑

#### 阶段四：前端主界面重构（3-4天）

**任务4.1：导航系统和布局**
- 创建侧边导航组件（基于用户角色显示菜单）
- 重构App.jsx为主布局组件
- 实现页面路由系统（React Router）
- 添加用户信息显示和退出登录功能

**任务4.2：用户管理界面（管理员专用）**
- 创建用户列表页面（表格展示所有字段）
- 实现用户操作功能（禁用、删除、重置密码、角色设置）
- 添加操作确认对话框
- 实现实时数据更新

**任务4.3：个人信息页面**
- 创建个人信息展示组件
- 实现信息编辑功能（昵称、邮箱）
- 实现密码修改功能（当前密码验证）
- 添加表单验证和成功提示

#### 阶段五：Todo功能升级（2-3天）

**任务5.1：Todo列表权限控制**
- 更新Todo列表API调用（基于用户权限）
- 实现软删除状态显示（管理员可见，浅灰色样式）
- 更新删除按钮逻辑（删除 vs 撤回图标）
- 添加管理员恢复Todo功能

**任务5.2：界面优化和测试**
- 优化删除状态的视觉效果
- 添加加载状态和错误处理
- 进行端到端功能测试
- 性能优化和代码重构

---

## 📅 开发计划时间表

| 阶段 | 任务 | 预计时间 | 累计时间 |
|------|------|----------|----------|
| 一 | 后端用户认证系统 | 3-4天 | 3-4天 |
| 二 | Todo模型升级 | 1-2天 | 4-6天 |
| 三 | 前端认证系统 | 3-4天 | 7-10天 |
| 四 | 前端主界面重构 | 3-4天 | 10-14天 |
| 五 | Todo功能升级 | 2-3天 | 12-17天 |

**总预计时间：12-17天（约2.5-3.5周）**

---

## 🎯 建议的开发顺序

1. **任务1.1** → **任务1.2** → **任务1.3**（建立完整后端认证系统）
2. **任务2.1** → **任务2.2**（升级Todo数据模型）
3. **任务3.1** → **任务3.2**（前端认证基础）
4. **任务4.1**（导航系统，为后续页面提供框架）
5. **任务4.2** → **任务4.3**（功能页面开发）
6. **任务5.1** → **任务5.2**（Todo升级和最终优化）

---

## 🔍 关键技术要点

### 后端关键实现
- JWT配置：`ACCESS_TOKEN_LIFETIME = timedelta(hours=18)`
- 权限装饰器：`@permission_classes([IsAuthenticated, IsAdminUser])`
- 软删除查询：`Todo.objects.filter(is_deleted=False, created_by=request.user)`

### 前端关键实现
- Context状态管理：用户信息、权限、登录状态
- 路由守卫：检查认证状态和权限
- API拦截器：自动token处理和错误处理

### 数据库设计要点
- User模型扩展：昵称、状态、最后登录时间
- Todo模型扩展：创建人外键、删除标记
- 索引优化：创建人、删除标记字段添加索引
